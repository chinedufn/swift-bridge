<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Why a Bridge Module - The swift-bridge Book</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../../favicon.svg">
                        <link rel="shortcut icon" href="../../favicon.png">
                <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
                <link rel="stylesheet" href="../../css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../index.html">Introduction</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="../../building/index.html"><strong aria-hidden="true">1.</strong> Building</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../building/xcode-and-cargo/index.html"><strong aria-hidden="true">1.1.</strong> Xcode + Cargo</a></li><li class="chapter-item expanded "><a href="../../building/swiftc-and-cargo/index.html"><strong aria-hidden="true">1.2.</strong> swiftc + Cargo</a></li><li class="chapter-item expanded "><a href="../../building/swift-packages/index.html"><strong aria-hidden="true">1.3.</strong> Swift Packages</a></li></ol></li><li class="chapter-item expanded "><a href="../../bridge-module/index.html"><strong aria-hidden="true">2.</strong> The Bridge Module</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../bridge-module/functions/index.html"><strong aria-hidden="true">2.1.</strong> Functions</a></li><li class="chapter-item expanded "><a href="../../bridge-module/opaque-types/index.html"><strong aria-hidden="true">2.2.</strong> Opaque Types</a></li><li class="chapter-item expanded "><a href="../../bridge-module/transparent-types/index.html"><strong aria-hidden="true">2.3.</strong> Transparent Types</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../bridge-module/transparent-types/structs/index.html"><strong aria-hidden="true">2.3.1.</strong> Transparent Structs</a></li><li class="chapter-item expanded "><a href="../../bridge-module/transparent-types/enums/index.html"><strong aria-hidden="true">2.3.2.</strong> Transparent Enums</a></li></ol></li><li class="chapter-item expanded "><a href="../../bridge-module/generics/index.html"><strong aria-hidden="true">2.4.</strong> Generics</a></li><li class="chapter-item expanded "><a href="../../bridge-module/conditional-compilation/index.html"><strong aria-hidden="true">2.5.</strong> Conditional Compilation</a></li><li class="chapter-item expanded "><a href="../../bridge-module/why-a-bridge-module/index.html" class="active"><strong aria-hidden="true">2.6.</strong> Why a Bridge Module</a></li></ol></li><li class="chapter-item expanded "><a href="../../built-in/index.html"><strong aria-hidden="true">3.</strong> Built In Types</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../built-in/string/index.html"><strong aria-hidden="true">3.1.</strong> String &lt;---&gt; String</a></li><li class="chapter-item expanded "><a href="../../built-in/str/index.html"><strong aria-hidden="true">3.2.</strong> &amp;str &lt;---&gt; RustStr</a></li><li class="chapter-item expanded "><a href="../../built-in/vec/index.html"><strong aria-hidden="true">3.3.</strong> Vec &lt;---&gt; RustVec</a></li><li class="chapter-item expanded "><a href="../../built-in/option/index.html"><strong aria-hidden="true">3.4.</strong> Option &lt;---&gt; Optional</a></li><li class="chapter-item expanded "><a href="../../built-in/result/index.html"><strong aria-hidden="true">3.5.</strong> Result&lt;T, E&gt; &lt;---&gt; RustResult&lt;T, E&gt;</a></li><li class="chapter-item expanded "><a href="../../built-in/boxed-functions/index.html"><strong aria-hidden="true">3.6.</strong> Box&lt;dyn FnOnce(A, B) -&gt; C&gt;</a></li><li class="chapter-item expanded "><a href="../../built-in/tuple/index.html"><strong aria-hidden="true">3.7.</strong> (A, B, C, ...) &lt;---&gt; (A, B, C, ...)</a></li></ol></li><li class="chapter-item expanded "><a href="../../safety/index.html"><strong aria-hidden="true">4.</strong> Safety</a></li><li class="chapter-item expanded "><a href="../../contributing/index.html"><strong aria-hidden="true">5.</strong> Contributing to swift-bridge</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../contributing/internal-design/index.html"><strong aria-hidden="true">5.1.</strong> Internal Design</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../contributing/internal-design/codegen/index.html"><strong aria-hidden="true">5.1.1.</strong> Code Generation</a></li></ol></li><li class="chapter-item expanded "><a href="../../contributing/adding-support-for-a-signature/index.html"><strong aria-hidden="true">5.2.</strong> Adding support for a signature</a></li><li class="chapter-item expanded "><a href="../../contributing/adding-compile-time-errors/index.html"><strong aria-hidden="true">5.3.</strong> Adding compile time errors</a></li><li class="chapter-item expanded "><a href="../../contributing/pull-requests/index.html"><strong aria-hidden="true">5.4.</strong> Pull Requests</a></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">The swift-bridge Book</h1>

                    <div class="right-buttons">
                                                <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/chinedufn/swift-bridge" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="why-a-bridge-module"><a class="header" href="#why-a-bridge-module">Why a Bridge Module?</a></h1>
<p>The <code>swift-bridge</code> project provides direct support for expressing the Rust+Swift FFI boundary using one or more bridge modules such as:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[swift_bridge::bridge]
mod ffi {
    extern &quot;Rust&quot; {
        fn generate_random_number() -&gt; u32;
    }
}

fn generate_random_number() -&gt; u32 {
    rand::random()
}
<span class="boring">}
</span></code></pre></pre>
<p><code>swift-bridge</code>'s original maintainer wrote <code>swift-bridge</code> for use in a cross platform application where he preferred to keep his FFI code separate from his application code.
He believed that this separation would reduce the likelihood of him biasing his core application's design towards types that were easier to bridge to Swift.</p>
<p>While in the future <code>swift-bridge</code> may decide to directly support other approaches to defining FFI boundaries, at present only the bridge module approach is directly supported.</p>
<p>Users with other needs can write wrappers around <code>swift-bridge</code> to expose alternative frontends.</p>
<p>The <code>examples/without-a-bridge-macro</code> example demonstrates how to reuse <code>swift-bridge</code>'s code generation facilities without using a bridge module.</p>
<h2 id="inline-annotations"><a class="header" href="#inline-annotations">Inline Annotations</a></h2>
<p>The main alternative to the bridge module design would be to support inline annotations where one could describe their FFI boundary by annotating their Rust types.</p>
<p>For instance a user might wish to expose their Rust banking code to Swift using an approach such as:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// IMAGINARY CODE. WE DO NOT PROVIDE A WAY TO DO THIS.

#[derive(Swift)]
pub struct BankAccount {
    balance: u32
}

#[swift_bridge::bridge]
pub fn create_bank_account() -&gt; BankAccount {
    BankAccount {
        balance: 0
    }
}
<span class="boring">}
</span></code></pre></pre>
<p><code>swift-bridge</code> aims to be a low-level library that generates far more efficient FFI code than a human would write and maintain themselves.</p>
<p>The more information that <code>swift-bridge</code> has at compile time, the more efficient code it can generate.</p>
<p>Let's explore an example of bridging a <code>UserId</code> type, along with a function that returns the latest <code>UserId</code> in the system.</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>type Uuid = [u8; 16];

#[derive(Copy)]
struct UserId(Uuid);

pub fn get_latest_user() -&gt; Result&lt;UserId, ()&gt; {
    Ok(UserId([123; 16]))
}
<span class="boring">}
</span></code></pre></pre>
<p>In our example, the <code>UserId</code> is a wrapper around a 16 byte UUID.</p>
<p>Exposing this as a bridge module might look like:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[swift_bridge::bridge]
mod ffi {
    extern &quot;Rust&quot; {
        #[swift_bridge(Copy(16))]
        type UserId;

        fn get_latest_user() -&gt; UserId;
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>Exposing the <code>UserId</code> using inlined annotation might look something like:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// WE DO NOT SUPPORT THIS

type Uuid = [u8; 16];

#[derive(Copy, ExposeToSwift)]
struct UserId(Uuid);

#[swift_bridge::bridge]
pub fn get_latest_user() -&gt; Result&lt;UserId, ()&gt; {
    UserId([123; 16])
}
<span class="boring">}
</span></code></pre></pre>
<p>In the bridge module example, <code>swift-bridge</code> knows at compile time that the <code>UserId</code> implements <code>Copy</code> and has a size of <code>16</code> bytes.</p>
<p>In the inlined annotation example, however, <code>swift-bridge</code> does not know the <code>UserId</code> implements <code>Copy</code>.</p>
<p>While it would be possible to inline this information, it would mean that users would need to remember to inline this information
on every function that used the <code>UserId</code>.</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// WE DO NOT SUPPORT THIS

#[swift_bridge::bridge]
#[swift_bridge(UserId impl Copy(16))]
pub fn get_latest_user() -&gt; Result&lt;UserId, ()&gt; {
    UserId([123; 16])
}
<span class="boring">}
</span></code></pre></pre>
<p>We expect that users would find it difficult to remember to repeat such annotations, meaning users would tend to expose less efficient bridges
than they otherwise could have.</p>
<p>If <code>swift-bridge</code> does not know that the <code>UserId</code> implements <code>Copy</code>, it will need to generate code like:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub extern &quot;C&quot; fn __swift_bridge__get_latest_user() -&gt; *mut UserId {
    let user = get_latest_user();
    match user {
        Ok(user) =&gt; Box::new(Box::into_raw(user)),
        Err(()) =&gt; std::ptr::null_mut() as *mut UserId,
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>Whereas if <code>swift-bridge</code> knows that the <code>UserId</code> implements <code>Copy</code>, it might be able to avoid an allocation by generating code such as:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// `swift-bridge` could conceivably generate code like this to bridge
/// a `Result&lt;UserId, ()&gt;`.
/// Here we use a 17 byte array where the first byte indicates `Ok` or `Err`
/// and, then `Ok`, the last 16 bytes hold the `UserId`.
/// We expect this to be more performant than the boxing in the previous
/// example codegen.
pub extern &quot;C&quot; fn __swift_bridge__get_latest_user() -&gt; [u8; 17] {
    let mut bytes: [u8; 17] = [0; 17];

    let user = get_latest_user();

    match user {
        Ok(user) =&gt; {
            let user_bytes: [u8; 16] = unsafe { std::mem::transmute(user) };
            (&amp;mut bytes[1..]).copy_from_slice(&amp;user_bytes);

            bytes[0] = 255;
            bytes
        }
        Err(()) =&gt; {
            bytes
        }
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>More generally, the more information that <code>swift-bridge</code> has about the FFI interface, the more optimized code it can generate.
The bridge module design steers users towards providing more information to <code>swift-bridge</code>, which we expect to lead to more efficient
applications.</p>
<p>Users that do not need such efficiency can explore reusing <code>swift-bridge</code> in alternative projects that better meet their needs.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../../bridge-module/conditional-compilation/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../../built-in/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../../bridge-module/conditional-compilation/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../../built-in/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
