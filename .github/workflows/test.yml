name: test

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - uses: actions-rs/toolchain@v1
      with:
        toolchain: stable

    - name: Rust Version Info
      run: rustc --version && cargo --version

    - name: Run tests
      run: RUSTFLAGS="-D warnings" cargo test --workspace
  
  integration-test:
    runs-on: macOS-11
    steps:
    - uses: actions/checkout@v1

    - uses: actions-rs/toolchain@v1
      with:
        toolchain: stable

    # Make sure the files that we will generate exist before the build begins.
    # This prevents the "Build input files cannot be found" error for generated files.
    - name: Create generated files
      run: PROJECT_DIR="$(pwd)/SwiftRustIntegrationTestRunner" ./SwiftRustIntegrationTestRunner/build-rust.sh

    - name: Run integration tests
      run: ./test-integration.sh
